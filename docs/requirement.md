# 요구사항 명세서: 예약 완료 처리 (고객 정보 입력 및 예약 확정)

## 1. 개요

본 문서는 콘서트 예매 시스템의 **유저플로우 #5: 예약 완료 처리** 기능에 대한 상세 요구사항을 정의합니다. 이 기능은 사용자가 좌석을 선택한 후 고객 정보를 입력하고 최종적으로 예약을 확정하는 전체 프로세스를 포함합니다.

---

## 2. 기능 범위

### 2.1. 주요 기능
1. **좌석 선택 완료 버튼 활성화**: 좌석이 1석 이상 선택된 경우에만 활성화
2. **좌석 유효성 재검증**: 서버에서 선택된 좌석들이 여전히 예약 가능한지 확인
3. **고객 정보 입력 폼 표시**: 이름, 휴대폰 번호, 이메일(선택) 입력
4. **실시간 입력 검증**: 각 필드에 대한 클라이언트 사이드 유효성 검증
5. **예약 확정 처리**: 트랜잭션 기반 예약 생성 및 좌석 상태 업데이트
6. **중복 예약 방지**: 동일 회차에 대한 동일 연락처 중복 예약 차단
7. **예약 완료 페이지 이동**: 예약 성공 시 예약 번호와 함께 완료 페이지로 전환

### 2.2. 제외 사항
- 결제 처리 (추후 구현 예정)
- 회원가입/로그인 (비회원 예약만 지원)
- 예약 수정 기능 (취소만 지원)

---

## 3. 화면 구성

### 3.1. 좌석 선택 완료 전 상태

#### 3.1.1. 예매 정보 섹션
**위치**: 화면 우측 (데스크톱) 또는 하단 (모바일)

**구성 요소**:
- **선택된 좌석 목록**
  - 좌석 번호 (예: A10, B05)
  - 좌석 등급 (R, S, A)
  - 좌석별 가격
  - 각 좌석 항목 우측에 'X' 버튼 (선택 취소용)

- **총 결제 금액**
  - 선택된 좌석 가격의 합계
  - 폰트: Inter SemiBold 24px
  - 색상: Primary Color (#5C6BFF)

- **'좌석 선택 완료' 버튼**
  - 위치: 예매 정보 섹션 하단
  - 크기: 전체 너비, 높이 48px
  - 배경: Primary Color (#5C6BFF)
  - 텍스트: "좌석 선택 완료" (Inter Medium 16px, White)
  - 비활성화 상태: 좌석 미선택 시 회색 배경 (#9CA3AF), 클릭 불가
  - 활성화 상태: 좌석 1석 이상 선택 시 Primary Color, 호버 시 #4854FF

**동작**:
- 좌석을 선택하거나 취소할 때마다 실시간으로 목록 및 총액 업데이트
- 선택된 좌석이 없으면 버튼 비활성화
- 선택된 좌석이 1석 이상이면 버튼 활성화

### 3.2. 고객 정보 입력 폼 (모달)

#### 3.2.1. 모달 구조
**트리거**: '좌석 선택 완료' 버튼 클릭

**모달 스펙**:
- 최대 너비: 560px
- 테두리 반경: 12px
- 배경: White (#FFFFFF) / 다크 테마 시 (#1F2937)
- 오버레이: rgba(13, 14, 36, 0.9)
- 패딩: 24px
- 애니메이션: 페이드 인 + 스케일 업 (200ms ease-out)

#### 3.2.2. 모달 내부 구성

**헤더**:
- 제목: "예약자 정보 입력" (Inter SemiBold 20px)
- 닫기 버튼 (X 아이콘, 우측 상단)

**선택된 좌석 요약**:
- 좌석 번호 목록 (예: A10, B05, C12)
- 총 결제 금액 (Inter Medium 18px, Primary Color)

**입력 필드 1: 이름**
- 라벨: "이름" + 필수 표시 (*)
- Input Type: text
- Placeholder: "홍길동"
- 최소 길이: 2자
- 최대 길이: 50자
- 허용 문자: 한글, 영문, 공백
- 실시간 검증:
  - 2자 미만: "이름은 최소 2자 이상 입력해주세요"
  - 50자 초과: "이름은 최대 50자까지 입력 가능합니다"
  - 특수문자 포함: "이름은 한글, 영문, 공백만 입력 가능합니다"

**입력 필드 2: 휴대폰 번호**
- 라벨: "휴대폰 번호" + 필수 표시 (*)
- Input Type: tel
- Placeholder: "010-1234-5678"
- 형식: 010-XXXX-XXXX (자동 하이픈 삽입)
- 실시간 검증:
  - 형식 불일치: "휴대폰 번호는 010-1234-5678 형식으로 입력해주세요"
  - 숫자 외 입력: 자동 제거 (클라이언트에서 숫자만 허용)

**입력 필드 3: 이메일 (선택)**
- 라벨: "이메일" + 선택 표시 (선택)
- Input Type: email
- Placeholder: "example@domain.com"
- 실시간 검증:
  - 입력이 있을 경우 이메일 형식 검증
  - 형식 불일치: "올바른 이메일 형식이 아닙니다 (예: example@domain.com)"
  - 비어있을 경우: 검증 생략

**액션 버튼**:
- **'예약 확정' 버튼**
  - 크기: 전체 너비, 높이 48px
  - 배경: Primary Color (#5C6BFF)
  - 텍스트: "예약 확정" (Inter Medium 16px, White)
  - 비활성화 조건: 필수 입력 미완료 또는 유효성 검증 실패
  - 활성화 시: 호버 시 #4854FF
  - 로딩 상태: 버튼 내 스피너 표시, 텍스트 "처리 중..."

- **'취소' 버튼**
  - 크기: 전체 너비, 높이 48px
  - 배경: transparent
  - 텍스트: "취소" (Inter Medium 16px, #6B7280)
  - 테두리: 1px solid #E5E7EB
  - 클릭 시: 모달 닫기, 입력 데이터 초기화

#### 3.2.3. 입력 필드 상태별 스타일

**기본 상태**:
- 배경: White (#FFFFFF)
- 테두리: 1px solid #E5E7EB
- 패딩: 12px 16px
- 테두리 반경: 8px
- 폰트: Inter Regular 14px

**포커스 상태**:
- 테두리: 2px solid #28E0FF
- 그림자: 0 0 0 3px rgba(40, 224, 255, 0.1)

**오류 상태**:
- 테두리: 2px solid #EF4444
- 오류 메시지: Inter Regular 12px, #EF4444
- 오류 메시지 위치: 필드 하단 4px 간격

**성공 상태** (유효성 검증 통과):
- 테두리: 1px solid #10B981
- 체크 아이콘: 필드 우측

### 3.3. 로딩 상태

**좌석 유효성 검증 중**:
- 모달 오픈 전 로딩 오버레이 표시
- 스피너 + "좌석 확인 중..." 텍스트
- 지속 시간: 일반적으로 500ms 이내

**예약 확정 처리 중**:
- 모달 내 버튼을 로딩 상태로 변경
- 버튼 텍스트: "예약 확정" → "처리 중..."
- 버튼 비활성화
- 스피너 표시

### 3.4. 예약 완료 페이지

**전환 조건**: 예약 확정 성공 시 자동 리다이렉트

**URL**: `/booking/success?reservationId={UUID}`

**화면 구성** (이 기능 범위 밖이나 참고용으로 명시):
- 성공 메시지
- 예약 번호
- 콘서트 정보
- 관람 일시
- 선택한 좌석 정보
- 총 결제 금액
- 후속 액션 버튼

---

## 4. 사용자 행동 플로우

### 4.1. 정상 흐름 (Happy Path)

```
1. 사용자가 좌석 배치도에서 좌석 1~4개 선택
   ↓
2. 예매 정보 섹션에 선택된 좌석 목록 및 총액 표시
   ↓
3. '좌석 선택 완료' 버튼 활성화
   ↓
4. 사용자가 '좌석 선택 완료' 버튼 클릭
   ↓
5. 시스템이 선택된 좌석의 유효성을 서버에서 재검증
   ↓
6. 모든 좌석이 예약 가능한 경우 고객 정보 입력 모달 표시
   ↓
7. 사용자가 이름 입력 → 실시간 검증 (2-50자, 한글/영문/공백)
   ↓
8. 사용자가 휴대폰 번호 입력 → 실시간 검증 (010-XXXX-XXXX 형식)
   ↓
9. (선택) 사용자가 이메일 입력 → 실시간 검증 (이메일 형식)
   ↓
10. 모든 필수 입력이 완료되면 '예약 확정' 버튼 활성화
   ↓
11. 사용자가 '예약 확정' 버튼 클릭
   ↓
12. 시스템이 트랜잭션 시작
   ↓
13. 좌석 상태 재확인 (SELECT FOR UPDATE)
   ↓
14. 중복 예약 여부 확인
   ↓
15. Reservations 테이블에 새 레코드 INSERT
   ↓
16. Seats 테이블의 해당 좌석들 status를 'reserved'로 UPDATE
   ↓
17. 트랜잭션 커밋
   ↓
18. 예약 번호(UUID) 생성 및 반환
   ↓
19. 예약 완료 페이지로 리다이렉트
```

### 4.2. 오류 흐름 (Error Paths)

#### 4.2.1. 좌석 유효성 검증 실패 (동시성 충돌)
```
사용자가 '좌석 선택 완료' 버튼 클릭
   ↓
시스템이 좌석 상태 재확인
   ↓
하나 이상의 좌석이 이미 'reserved' 상태로 변경됨
   ↓
에러 토스트 표시: "선택하신 좌석이 이미 예약되었습니다. 다른 좌석을 선택해주세요"
   ↓
좌석 배치도 자동 새로고침 (예약된 좌석 비활성화)
   ↓
사용자가 다른 좌석 재선택
```

#### 4.2.2. 고객 정보 입력 오류
```
사용자가 필드에 잘못된 값 입력
   ↓
실시간 검증 실행
   ↓
필드 하단에 오류 메시지 표시
   ↓
필드 테두리 빨간색으로 변경
   ↓
'예약 확정' 버튼 비활성화 유지
   ↓
사용자가 올바른 값으로 수정
   ↓
오류 메시지 사라짐, 필드 테두리 초록색 체크 표시
   ↓
모든 필수 입력이 유효하면 '예약 확정' 버튼 활성화
```

#### 4.2.3. 중복 예약 시도
```
사용자가 '예약 확정' 버튼 클릭
   ↓
시스템이 중복 예약 여부 확인 (동일 휴대폰 번호 + 동일 회차)
   ↓
중복 예약 감지
   ↓
트랜잭션 롤백
   ↓
에러 토스트 표시: "이미 해당 공연에 대한 예약이 존재합니다"
   ↓
모달 유지 (사용자가 다른 번호 입력 가능)
```

#### 4.2.4. 예약 확정 중 동시성 충돌
```
사용자가 '예약 확정' 버튼 클릭
   ↓
시스템이 트랜잭션 시작 및 좌석 상태 재확인 (SELECT FOR UPDATE)
   ↓
다른 사용자가 먼저 동일 좌석 예약 완료
   ↓
좌석 상태가 'reserved'로 변경됨
   ↓
트랜잭션 롤백
   ↓
에러 토스트 표시: "선택하신 좌석이 이미 예약되었습니다. 다른 좌석을 선택해주세요"
   ↓
모달 닫기
   ↓
좌석 배치도 자동 새로고침
   ↓
사용자가 다른 좌석 재선택
```

#### 4.2.5. 네트워크 오류
```
사용자가 '예약 확정' 버튼 클릭
   ↓
요청 전송 중 네트워크 오류 발생
   ↓
에러 토스트 표시: "예약 처리 중 오류가 발생했습니다. 다시 시도해주세요"
   ↓
모달 유지 (입력한 정보 보존)
   ↓
'재시도' 버튼 표시
   ↓
사용자가 '재시도' 버튼 클릭 → 다시 예약 확정 시도
```

#### 4.2.6. 서버 오류
```
사용자가 '예약 확정' 버튼 클릭
   ↓
서버에서 데이터베이스 오류 또는 내부 오류 발생
   ↓
에러 토스트 표시: "예약 처리에 실패했습니다. 잠시 후 다시 시도해주세요"
   ↓
모달 하단에 고객센터 연락처 표시
   ↓
사용자가 나중에 다시 시도하거나 고객센터 문의
```

---

## 5. 데이터 흐름

### 5.1. 데이터베이스 테이블

#### 5.1.1. Reservations 테이블
```sql
CREATE TABLE reservations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    schedule_id UUID NOT NULL REFERENCES schedules(id),
    seat_ids UUID[] NOT NULL,
    total_price INTEGER NOT NULL,
    customer_name VARCHAR(100) NOT NULL,
    customer_phone VARCHAR(20) NOT NULL,
    customer_email VARCHAR(255),
    status VARCHAR(20) NOT NULL DEFAULT 'confirmed',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    cancelled_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### 5.1.2. Seats 테이블
```sql
CREATE TABLE seats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    schedule_id UUID NOT NULL REFERENCES schedules(id),
    seat_number VARCHAR(10) NOT NULL,
    grade VARCHAR(5) NOT NULL,
    price INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'available',
    reservation_id UUID REFERENCES reservations(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 5.2. API 엔드포인트

#### 5.2.1. POST /api/booking/validate-seats
**목적**: 좌석 선택 완료 버튼 클릭 시 좌석 유효성 재검증

**요청**:
```json
{
  "scheduleId": "uuid",
  "seatIds": ["uuid1", "uuid2", "uuid3"]
}
```

**응답 (성공)**:
```json
{
  "success": true,
  "data": {
    "valid": true
  }
}
```

**응답 (실패 - 좌석 예약됨)**:
```json
{
  "success": false,
  "error": {
    "code": "SEATS_NOT_AVAILABLE",
    "message": "선택하신 좌석이 이미 예약되었습니다",
    "unavailableSeats": ["uuid2"]
  }
}
```

**데이터베이스 쿼리**:
```sql
SELECT id, status 
FROM seats 
WHERE id = ANY($1::UUID[]) 
  AND schedule_id = $2;
```

**비즈니스 로직**:
1. 모든 `seatIds`에 대해 `status`가 `'available'`인지 확인
2. 하나라도 `'reserved'`인 경우 실패 응답 반환
3. 모든 좌석이 `'available'`이면 성공 응답 반환

#### 5.2.2. POST /api/booking/reserve
**목적**: 예약 확정 처리 (트랜잭션 기반)

**요청**:
```json
{
  "scheduleId": "uuid",
  "seatIds": ["uuid1", "uuid2", "uuid3"],
  "customerName": "홍길동",
  "phoneNumber": "010-1234-5678",
  "email": "example@domain.com"
}
```

**응답 (성공)**:
```json
{
  "success": true,
  "data": {
    "reservationId": "uuid",
    "reservationNumber": "uuid",
    "totalPrice": 450000,
    "createdAt": "2024-12-25T10:30:00Z"
  }
}
```

**응답 (실패 - 동시성 충돌)**:
```json
{
  "success": false,
  "error": {
    "code": "SEATS_NOT_AVAILABLE",
    "message": "선택하신 좌석이 이미 예약되었습니다"
  }
}
```

**응답 (실패 - 중복 예약)**:
```json
{
  "success": false,
  "error": {
    "code": "DUPLICATE_RESERVATION",
    "message": "이미 해당 공연에 대한 예약이 존재합니다"
  }
}
```

**데이터베이스 트랜잭션**:
```sql
BEGIN;

-- 1. 좌석 상태 재확인 (락 획득)
SELECT id, status 
FROM seats 
WHERE id = ANY($1::UUID[]) 
  AND schedule_id = $2
FOR UPDATE;

-- 2. 모든 좌석이 'available'인지 검증
-- (애플리케이션 레벨에서 수행)

-- 3. 중복 예약 여부 확인
SELECT id 
FROM reservations 
WHERE customer_phone = $3 
  AND schedule_id = $2 
  AND status = 'confirmed';

-- 4. 중복 예약이 없는 경우 예약 생성
INSERT INTO reservations (
    schedule_id, 
    seat_ids, 
    total_price, 
    customer_name, 
    customer_phone, 
    customer_email, 
    status
) VALUES ($2, $1, $4, $5, $3, $6, 'confirmed')
RETURNING id;

-- 5. 좌석 상태 업데이트
UPDATE seats 
SET status = 'reserved', 
    reservation_id = $7,
    updated_at = NOW()
WHERE id = ANY($1::UUID[]);

COMMIT;
```

**트랜잭션 실패 시**:
```sql
ROLLBACK;
```

### 5.3. 데이터 변화 과정

#### 5.3.1. 예약 전 상태
**Seats 테이블**:
```
| id    | seat_number | status    | reservation_id |
|-------|-------------|-----------|----------------|
| uuid1 | A10         | available | null           |
| uuid2 | A11         | available | null           |
| uuid3 | B05         | reserved  | uuid-other     |
```

#### 5.3.2. 예약 중 (트랜잭션 진행)
**좌석 락 획득**:
```sql
SELECT ... FOR UPDATE
-- uuid1, uuid2에 대해 배타적 락 획득
-- 다른 트랜잭션은 이 좌석들을 읽거나 수정할 수 없음
```

**Reservations 테이블 INSERT**:
```
| id         | schedule_id | seat_ids        | customer_name | customer_phone | status    |
|------------|-------------|-----------------|---------------|----------------|-----------|
| uuid-new   | uuid-sch    | [uuid1, uuid2]  | 홍길동        | 010-1234-5678  | confirmed |
```

**Seats 테이블 UPDATE**:
```
| id    | seat_number | status    | reservation_id |
|-------|-------------|-----------|----------------|
| uuid1 | A10         | reserved  | uuid-new       |
| uuid2 | A11         | reserved  | uuid-new       |
| uuid3 | B05         | reserved  | uuid-other     |
```

#### 5.3.3. 예약 후 상태 (커밋 완료)
**최종 상태**:
- `reservations` 테이블에 새 예약 레코드 생성 완료
- `seats` 테이블에서 해당 좌석들의 `status`가 `'reserved'`로 변경
- `seats` 테이블에서 해당 좌석들의 `reservation_id`가 예약 ID로 설정
- 락 해제

---

## 6. 비즈니스 규칙

### 6.1. 입력 검증 규칙

#### 6.1.1. 이름 (customer_name)
- **필수 여부**: 필수
- **최소 길이**: 2자
- **최대 길이**: 50자
- **허용 문자**: 한글, 영문 대소문자, 공백
- **검증 타이밍**: 실시간 (onChange)
- **정규식**: `/^[가-힣a-zA-Z\s]{2,50}$/`

#### 6.1.2. 휴대폰 번호 (customer_phone)
- **필수 여부**: 필수
- **형식**: 010-XXXX-XXXX
- **자동 포맷팅**: 숫자 입력 시 자동으로 하이픈 삽입
- **검증 타이밍**: 실시간 (onChange)
- **정규식**: `/^010-\d{4}-\d{4}$/`

#### 6.1.3. 이메일 (customer_email)
- **필수 여부**: 선택
- **형식**: 표준 이메일 형식
- **검증 타이밍**: 실시간 (onChange, 값이 있을 경우에만)
- **정규식**: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`

### 6.2. 좌석 선택 규칙

#### 6.2.1. 좌석 수 제한
- **최소 선택**: 1석
- **최대 선택**: 4석
- **초과 시 동작**: 5번째 좌석 클릭 시 토스트 메시지 표시 ("최대 4석까지 선택 가능합니다"), 선택 무시

#### 6.2.2. 좌석 상태 검증
- **1차 검증**: 좌석 클릭 시 클라이언트에서 `status` 확인
- **2차 검증**: '좌석 선택 완료' 버튼 클릭 시 서버에서 재확인
- **3차 검증**: '예약 확정' 버튼 클릭 시 트랜잭션 내에서 최종 확인

### 6.3. 중복 예약 방지 규칙

#### 6.3.1. 중복 기준
- **동일 휴대폰 번호** + **동일 회차(schedule_id)** + **status='confirmed'**

#### 6.3.2. 중복 허용 케이스
- 다른 회차에 대한 예약
- 취소된 예약 (status='cancelled')

#### 6.3.3. 검증 시점
- 예약 확정 처리 시 트랜잭션 내에서 검증

#### 6.3.4. 검증 쿼리
```sql
SELECT id 
FROM reservations 
WHERE customer_phone = $1 
  AND schedule_id = $2 
  AND status = 'confirmed'
LIMIT 1;
```

### 6.4. 트랜잭션 규칙

#### 6.4.1. 격리 수준
- **권장 격리 수준**: SERIALIZABLE 또는 REPEATABLE READ
- **이유**: 동시 예약 충돌 방지

#### 6.4.2. 락 전략
- **SELECT FOR UPDATE** 사용
- **락 대상**: 선택된 좌석들의 레코드
- **락 타임아웃**: 5초 (설정 가능)

#### 6.4.3. 롤백 조건
- 좌석 상태가 'available'이 아닌 경우
- 중복 예약 감지
- 데이터베이스 오류 발생

#### 6.4.4. 커밋 조건
- 모든 검증 통과
- Reservations INSERT 성공
- Seats UPDATE 성공

### 6.5. 예약 번호 생성 규칙

#### 6.5.1. 형식
- **타입**: UUID v4
- **예시**: `550e8400-e29b-41d4-a716-446655440000`

#### 6.5.2. 생성 시점
- Reservations 테이블 INSERT 시 데이터베이스 함수로 자동 생성 (`gen_random_uuid()`)

#### 6.5.3. 고유성 보장
- UUID의 충돌 확률이 극히 낮음 (2^122분의 1)
- PRIMARY KEY 제약조건으로 중복 방지

---

## 7. 오류 처리

### 7.1. 오류 코드 정의

| 오류 코드                  | HTTP 상태 | 메시지                                                  | 사용자 액션                 |
|---------------------------|-----------|--------------------------------------------------------|-----------------------------|
| SEATS_NOT_AVAILABLE       | 409       | 선택하신 좌석이 이미 예약되었습니다                    | 다른 좌석 재선택            |
| DUPLICATE_RESERVATION     | 409       | 이미 해당 공연에 대한 예약이 존재합니다                | 다른 번호 입력 또는 취소    |
| INVALID_INPUT             | 400       | 입력 정보가 올바르지 않습니다                          | 입력 수정                   |
| NETWORK_ERROR             | 0         | 예약 처리 중 오류가 발생했습니다. 다시 시도해주세요    | 재시도                      |
| INTERNAL_SERVER_ERROR     | 500       | 예약 처리에 실패했습니다. 잠시 후 다시 시도해주세요    | 나중에 재시도 또는 고객센터 |
| VALIDATION_ERROR          | 400       | {필드별 구체적 오류 메시지}                            | 해당 필드 수정              |

### 7.2. 오류 표시 방식

#### 7.2.1. 입력 검증 오류
- **표시 위치**: 해당 입력 필드 하단
- **스타일**: 빨간색 텍스트 (Inter Regular 12px, #EF4444)
- **아이콘**: 느낌표 아이콘
- **지속 시간**: 사용자가 수정할 때까지

#### 7.2.2. API 오류 (동시성 충돌, 중복 예약 등)
- **표시 방식**: Toast 알림
- **위치**: 화면 우상단
- **배경**: 오류 색상 (#EF4444)
- **텍스트 색상**: White
- **아이콘**: X 마크
- **지속 시간**: 6초 (자동 닫힘)
- **액션**: 닫기 버튼 제공

#### 7.2.3. 네트워크 오류
- **표시 방식**: Toast 알림 + 모달 내 재시도 버튼
- **지속 시간**: 자동 닫히지 않음 (사용자가 닫을 때까지)
- **추가 정보**: 고객센터 연락처 제공

#### 7.2.4. 서버 오류
- **표시 방식**: Toast 알림 + 고객센터 연락처
- **지속 시간**: 자동 닫히지 않음
- **추가 정보**: "오류가 계속되면 고객센터로 문의해주세요"

---

## 8. 성능 요구사항

### 8.1. 응답 시간

| 작업                      | 목표 응답 시간 | 최대 허용 시간 |
|--------------------------|----------------|----------------|
| 좌석 유효성 검증          | 300ms          | 500ms          |
| 예약 확정 처리            | 500ms          | 1000ms         |
| 고객 정보 입력 검증       | 즉시 (50ms)    | 100ms          |

### 8.2. 동시 처리

- **동시 예약 요청**: 초당 100건 이상 처리 가능
- **좌석 락 타임아웃**: 5초
- **트랜잭션 타임아웃**: 10초

### 8.3. 캐싱 전략

#### 8.3.1. 캐싱하지 않는 데이터
- 좌석 상태 (실시간 정확성 필수)
- 예약 정보

#### 8.3.2. 캐싱 가능한 데이터
- 콘서트 기본 정보 (TTL: 5분)
- 회차 목록 (TTL: 1분)

---

## 9. 보안 요구사항

### 9.1. 입력 검증

#### 9.1.1. 클라이언트 사이드
- 모든 입력 필드에 대한 형식 검증
- XSS 방지를 위한 HTML 태그 제거

#### 9.1.2. 서버 사이드
- 클라이언트 검증을 우회한 요청 차단
- SQL Injection 방지 (파라미터화된 쿼리 사용)
- 입력 길이 제한 강제

### 9.2. API 보안

#### 9.2.1. Rate Limiting
- IP당 분당 최대 10건의 예약 시도
- 동일 휴대폰 번호로 분당 최대 3건의 예약 시도

#### 9.2.2. CSRF 방지
- CSRF 토큰 사용 (Next.js 기본 제공)

#### 9.2.3. 데이터 암호화
- HTTPS 강제 사용
- 민감 정보 (휴대폰 번호, 이메일) 전송 시 TLS 암호화

---

## 10. 접근성 요구사항

### 10.1. 키보드 네비게이션

- **Tab**: 다음 입력 필드로 이동
- **Shift + Tab**: 이전 입력 필드로 이동
- **Enter**: 활성화된 버튼 클릭 (예: '예약 확정' 버튼)
- **Esc**: 모달 닫기

### 10.2. 스크린 리더 지원

#### 10.2.1. ARIA 라벨
```html
<!-- 이름 입력 필드 -->
<input 
  type="text" 
  id="customer-name"
  aria-label="예약자 이름"
  aria-required="true"
  aria-invalid={hasError}
  aria-describedby="name-error"
/>
<span id="name-error" role="alert">{errorMessage}</span>

<!-- 휴대폰 번호 입력 필드 -->
<input 
  type="tel" 
  id="customer-phone"
  aria-label="예약자 휴대폰 번호"
  aria-required="true"
  aria-invalid={hasError}
  aria-describedby="phone-error phone-format"
/>
<span id="phone-format" class="sr-only">010-1234-5678 형식으로 입력해주세요</span>
<span id="phone-error" role="alert">{errorMessage}</span>

<!-- 예약 확정 버튼 -->
<button 
  type="submit"
  aria-label="예약 확정하기"
  aria-busy={isLoading}
  aria-disabled={!isValid}
>
  {isLoading ? '처리 중...' : '예약 확정'}
</button>
```

#### 10.2.2. 포커스 관리
- 모달 오픈 시 첫 번째 입력 필드에 자동 포커스
- 모달 닫기 시 '좌석 선택 완료' 버튼으로 포커스 복귀
- 탭 트랩: 모달 내부에서만 포커스 이동

### 10.3. 색상 대비

- **텍스트와 배경**: 최소 4.5:1 대비 비율
- **오류 메시지**: 색상 외에 아이콘으로도 표시
- **성공 상태**: 색상 외에 체크 아이콘으로도 표시

---

## 11. 모바일 최적화

### 11.1. 반응형 레이아웃

#### 11.1.1. 모바일 (< 768px)
- 고객 정보 입력 모달을 Bottom Sheet 방식으로 표시
- 버튼 높이: 48px (터치 영역 최소 44px 보장)
- 입력 필드 간격: 16px
- 좌우 패딩: 16px

#### 11.1.2. 태블릿 (768px - 1024px)
- 모달 너비: 최대 560px, 중앙 정렬
- 입력 필드 간격: 16px

#### 11.1.3. 데스크톱 (> 1024px)
- 모달 너비: 560px, 중앙 정렬
- 입력 필드 간격: 20px

### 11.2. 터치 최적화

- **최소 터치 영역**: 44×44px
- **버튼 간격**: 최소 8px
- **호버 효과**: 모바일에서는 active 상태만 표시

### 11.3. 가상 키보드 대응

- 입력 필드 포커스 시 화면 스크롤하여 필드가 키보드에 가려지지 않도록 조정
- iOS에서 `inputmode` 속성 사용:
  - 이름: `inputmode="text"`
  - 휴대폰 번호: `inputmode="tel"`
  - 이메일: `inputmode="email"`

---

## 12. 테스트 시나리오

### 12.1. 기능 테스트

#### 12.1.1. 정상 흐름 테스트
1. 좌석 1개 선택 → '좌석 선택 완료' 버튼 활성화 확인
2. '좌석 선택 완료' 버튼 클릭 → 고객 정보 입력 모달 표시 확인
3. 유효한 이름, 휴대폰 번호, 이메일 입력 → '예약 확정' 버튼 활성화 확인
4. '예약 확정' 버튼 클릭 → 예약 완료 페이지로 이동 확인
5. 데이터베이스에서 예약 레코드 생성 및 좌석 상태 'reserved' 변경 확인

#### 12.1.2. 좌석 유효성 검증 테스트
1. 좌석 A10 선택
2. 백그라운드에서 다른 사용자가 A10 예약
3. '좌석 선택 완료' 버튼 클릭
4. "선택하신 좌석이 이미 예약되었습니다" 에러 메시지 표시 확인
5. 좌석 배치도에서 A10이 'reserved' 상태로 변경 확인

#### 12.1.3. 입력 검증 테스트
1. 이름 필드에 "a" 입력 → "이름은 최소 2자 이상 입력해주세요" 오류 메시지 확인
2. 이름 필드에 "홍길동123" 입력 → "이름은 한글, 영문, 공백만 입력 가능합니다" 오류 메시지 확인
3. 휴대폰 번호 필드에 "010-123-4567" 입력 → 형식 오류 메시지 확인
4. 이메일 필드에 "example.com" 입력 → 이메일 형식 오류 메시지 확인

#### 12.1.4. 중복 예약 방지 테스트
1. 동일 휴대폰 번호(010-1234-5678)로 회차1에 대한 예약 완료
2. 같은 휴대폰 번호로 회차1에 대한 예약 재시도
3. "이미 해당 공연에 대한 예약이 존재합니다" 에러 메시지 확인
4. 같은 휴대폰 번호로 회차2에 대한 예약 시도 → 정상 예약 가능 확인

### 12.2. 동시성 테스트

#### 12.2.1. 동시 예약 시도
1. 사용자A와 사용자B가 동시에 동일 좌석(A10) 선택
2. 둘 다 '좌석 선택 완료' 버튼 클릭
3. 둘 다 고객 정보 입력
4. 둘 다 '예약 확정' 버튼 클릭
5. 한 명만 예약 성공, 다른 한 명은 동시성 충돌 에러 확인
6. 데이터베이스에서 좌석 A10의 예약이 1건만 존재하는지 확인

### 12.3. 성능 테스트

#### 12.3.1. 응답 시간 테스트
1. 좌석 유효성 검증 API 응답 시간 측정 → 300ms 이내 확인
2. 예약 확정 API 응답 시간 측정 → 500ms 이내 확인

#### 12.3.2. 부하 테스트
1. 동시에 100명의 사용자가 예약 시도
2. 모든 요청이 정상 처리되는지 확인
3. 응답 시간이 허용 범위 내인지 확인

### 12.4. 접근성 테스트

#### 12.4.1. 키보드 네비게이션 테스트
1. Tab 키로 모든 입력 필드 및 버튼 접근 가능 확인
2. Enter 키로 버튼 클릭 가능 확인
3. Esc 키로 모달 닫기 가능 확인

#### 12.4.2. 스크린 리더 테스트
1. NVDA 또는 JAWS로 모든 입력 필드의 라벨 읽기 확인
2. 오류 메시지가 `role="alert"`로 즉시 읽히는지 확인

### 12.5. 모바일 테스트

#### 12.5.1. 반응형 테스트
1. 다양한 화면 크기(320px ~ 1920px)에서 레이아웃 확인
2. 모바일에서 Bottom Sheet 방식 모달 표시 확인

#### 12.5.2. 터치 테스트
1. 모든 버튼과 입력 필드가 터치하기 쉬운 크기인지 확인 (최소 44×44px)
2. 가상 키보드가 입력 필드를 가리지 않는지 확인

---

## 13. 구현 우선순위

### 13.1. Phase 1 (MVP - 필수 기능)
1. 좌석 선택 완료 버튼 및 활성화 로직
2. 고객 정보 입력 모달 (이름, 휴대폰 번호)
3. 입력 검증 (클라이언트 사이드)
4. 예약 확정 API (/api/booking/reserve)
5. 트랜잭션 기반 예약 생성 및 좌석 상태 업데이트
6. 예약 완료 페이지 이동

### 13.2. Phase 2 (핵심 기능 강화)
1. 좌석 유효성 재검증 API (/api/booking/validate-seats)
2. 중복 예약 방지 로직
3. 동시성 충돌 처리 (SELECT FOR UPDATE)
4. 오류 처리 및 사용자 피드백 개선

### 13.3. Phase 3 (선택 기능 및 최적화)
1. 이메일 입력 (선택)
2. 네트워크 오류 재시도 로직
3. 접근성 개선 (ARIA, 키보드 네비게이션)
4. 성능 최적화 (응답 시간 단축)
5. 모바일 최적화 (Bottom Sheet, 가상 키보드 대응)

---

## 14. 참고 자료

### 14.1. 관련 문서
- `/docs/prd.md`: 프로젝트 전체 개요 및 목표
- `/docs/userflow.md`: 유저플로우 #5 상세 정의
- `/docs/database.md`: 데이터베이스 스키마 및 쿼리
- `/docs/design-guide.md`: UI/UX 디자인 가이드
- `/docs/pages/005/spec.md`: 유스케이스 명세

### 14.2. 기술 스택 문서
- Next.js 15: https://nextjs.org/docs
- React Hook Form: https://react-hook-form.com/
- Zod: https://zod.dev/
- TailwindCSS: https://tailwindcss.com/docs
- Supabase: https://supabase.com/docs

---

## 15. 변경 이력

| 날짜       | 버전  | 작성자 | 변경 내용                      |
|-----------|-------|--------|-------------------------------|
| 2024-12-25| 1.0   | -      | 초안 작성                     |
