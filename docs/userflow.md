# 콘서트 예매 시스템 유저플로우

## 개요

본 문서는 VMC3 콘서트 예매 시스템의 기능별 유저플로우를 정의합니다. 각 유저플로우는 입력(사용자 상호작용) → 처리(시스템 로직) → 출력(피드백 및 사이드이펙트) 단계로 구성되며, 발생 가능한 엣지케이스에 대한 대응 방안을 포함합니다.

---

## 🎯 **유저플로우 #1: 메인 페이지 - 콘서트 목록 조회**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- 사용자가 웹사이트 URL에 접속
- 페이지 스크롤 (콘서트 목록 탐색)
- 특정 콘서트 카드의 '예매하기' 버튼 클릭

### **2. 처리 (시스템 내부 로직)**
1. **초기 페이지 로드**
   - 데이터베이스에서 예매 가능한 콘서트 목록 조회 (Concert 테이블)
   - 각 콘서트의 기본 정보 (id, title, posterImageUrl) 추출
   - 콘서트별 예매 가능 여부 확인 (Schedule 테이블과 조인하여 미래 일정 존재 여부 체크)

2. **'예매하기' 버튼 클릭 시**
   - 선택된 콘서트 ID 추출
   - 해당 콘서트의 예매 가능 일정 존재 여부 재확인
   - 예약 페이지 URL 생성 (/booking/[concertId])

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 콘서트 목록이 카드 형태로 화면에 표시
  - '예매하기' 버튼 클릭 시 해당 콘서트의 예약 페이지로 이동
- **엣지케이스 처리**:
  - 예매 가능한 콘서트가 없는 경우: 안내 메시지 표시
  - 네트워크 오류 시: 재시도 버튼과 함께 오류 메시지 표시
  - 콘서트 데이터 로딩 중: 스켈레톤 UI 또는 로딩 인디케이터 표시
  - 선택한 콘서트의 일정이 모두 종료된 경우: 예매 불가 안내 후 메인 페이지 유지

---

## 🎯 **유저플로우 #2: 예약 페이지 - 날짜 선택**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- 예약 페이지 진입 (concertId 파라미터 포함)
- 캘린더에서 특정 날짜 클릭
- 다른 날짜로 변경 시 재클릭

### **2. 처리 (시스템 내부 로직)**
1. **페이지 초기 로드**
   - URL에서 concertId 추출 및 유효성 검증
   - Concert 테이블에서 콘서트 기본 정보 조회 (title, posterImageUrl, description)
   - Schedule 테이블에서 해당 콘서트의 모든 예매 가능한 일정 조회
   - 현재 날짜 이후의 일정만 필터링
   - 날짜별로 그룹화하여 캘린더에 표시할 활성 날짜 목록 생성

2. **날짜 선택 시**
   - 선택된 날짜 유효성 검증 (과거 날짜 방지, 예매 가능 날짜인지 확인)
   - 해당 날짜의 회차 정보 조회 (Schedule 테이블에서 dateTime 기준 필터링)
   - 회차별 잔여 좌석 수 계산 (Seat 테이블에서 status='available' 카운트)
   - 선택된 날짜 상태를 세션/로컬스토리지에 임시 저장

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 콘서트 기본 정보 표시
  - 예매 가능한 날짜들이 캘린더에 활성화되어 표시
  - 날짜 선택 시 해당 날짜가 하이라이트되고 회차 선택 섹션이 활성화
- **엣지케이스 처리**:
  - 유효하지 않은 concertId: 404 에러 페이지로 리다이렉트
  - 예매 가능한 날짜가 없는 경우: 매진 안내 메시지 표시
  - 과거 날짜 클릭 시: 선택 불가 안내 툴팁 표시
  - 네트워크 오류로 일정 로드 실패 시: 재시도 버튼과 함께 오류 메시지 표시
  - 콘서트 정보 로딩 중: 스켈레톤 UI 표시

---

## 🎯 **유저플로우 #3: 예약 페이지 - 회차 선택**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- 날짜가 이미 선택된 상태에서 회차 목록 확인
- 특정 회차(시간) 클릭
- 다른 회차로 변경 시 재클릭

### **2. 처리 (시스템 내부 로직)**
1. **회차 목록 표시**
   - 선택된 날짜 정보를 기반으로 Schedule 테이블에서 해당 날짜의 모든 회차 조회
   - 각 회차별 시간 정보 추출 (dateTime에서 시간 부분)
   - 각 회차별 잔여 좌석 수 계산 (Seat 테이블과 조인하여 status='available' 카운트)
   - 매진된 회차 식별 (잔여 좌석 수가 0인 경우)

2. **회차 선택 시**
   - 선택된 회차 유효성 검증 (매진 여부, 시간 유효성 확인)
   - 해당 회차의 scheduleId 추출
   - 좌석 배치도 데이터 조회 (Seat 테이블에서 scheduleId 기준으로 모든 좌석 정보)
   - 좌석별 상태 정보 (available/reserved) 및 등급, 가격 정보 로드
   - 선택된 회차 정보를 세션/로컬스토리지에 저장

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 선택된 날짜의 회차 목록이 시간순으로 표시
  - 각 회차별 잔여 좌석 수 표시
  - 회차 선택 시 해당 회차가 하이라이트되고 좌석 배치도 섹션이 활성화
  - 좌석 배치도에 실시간 좌석 현황 표시
- **엣지케이스 처리**:
  - 선택된 날짜에 회차가 없는 경우: 일정 없음 안내 메시지 표시
  - 모든 회차가 매진인 경우: 매진 안내 및 다른 날짜 선택 유도
  - 매진된 회차 클릭 시: 선택 불가 안내 및 대체 회차 추천
  - 좌석 데이터 로드 실패 시: 재시도 버튼과 함께 오류 메시지 표시
  - 회차 정보 로딩 중: 로딩 인디케이터 표시
  - 날짜가 선택되지 않은 상태에서 접근 시: 날짜 선택 유도 메시지 표시

---

## 🎯 **유저플로우 #4: 예약 페이지 - 좌석 선택**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- 좌석 배치도에서 선택 가능한 좌석 클릭
- 이미 선택한 좌석 재클릭 (선택 취소)
- 선택 불가능한 좌석 클릭 시도
- 최대 선택 가능 좌석 수 초과 시도

### **2. 처리 (시스템 내부 로직)**
1. **좌석 배치도 렌더링**
   - 선택된 회차의 scheduleId를 기반으로 Seat 테이블에서 모든 좌석 정보 조회
   - 좌석별 상태 분류 (available/reserved)
   - 좌석 등급별 색상 및 가격 정보 매핑
   - 좌석 배치도 UI에 좌석 상태별 시각적 표현

2. **좌석 선택 시**
   - 클릭된 좌석의 상태 확인 (available 여부)
   - **이미 예약된 좌석 차단**: reserved 상태인 좌석은 클릭 이벤트 무시
   - 현재 선택된 좌석 수 확인 (최대 4석 제한 검증)
   - 좌석 상태를 '내 선택'으로 변경 (클라이언트 사이드)
   - 선택된 좌석 목록에 추가 (seatId, seatNumber, grade, price)
   - 총 결제 금액 실시간 계산 및 업데이트

3. **좌석 선택 취소 시**
   - 선택된 좌석 목록에서 해당 좌석 제거
   - 좌석 상태를 '선택 가능'으로 복원
   - 총 결제 금액 재계산 및 업데이트

4. **실시간 좌석 상태 동기화 및 중복 예약 방지**
   - WebSocket 또는 주기적 폴링을 통해 서버에서 좌석 상태 실시간 업데이트
   - 다른 사용자가 예약 완료한 좌석을 즉시 'reserved' 상태로 변경하여 비활성화
   - 내가 선택한 좌석이 다른 사용자에 의해 예약된 경우 충돌 처리 및 선택 해제
   - Redis 기반 좌석 락(Lock) 시스템으로 동시 예약 시도 방지

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 좌석 배치도에 상태별 색상으로 좌석 표시
  - 좌석 선택 시 즉시 시각적 피드백 (색상 변경)
  - 예매 정보 섹션에 선택된 좌석 정보 실시간 표시
  - 총 결제 금액 실시간 업데이트
  - 좌석 선택 완료 버튼 활성화 (1석 이상 선택 시)
- **엣지케이스 처리**:
  - **이미 예약된 좌석 클릭 시**: 클릭 무시 및 "이미 예약된 좌석입니다" 툴팁 표시
  - 선택 불가능한 좌석 클릭 시: 클릭 무시 및 안내 툴팁 표시
  - 최대 선택 가능 좌석 수 초과 시: 경고 메시지 및 추가 선택 방지
  - **실시간 좌석 충돌**: 선택 중인 좌석이 다른 사용자에게 예약된 경우 즉시 선택 해제 및 안내
  - 좌석 상태 동기화 중 충돌 발생 시: 해당 좌석 선택 해제 및 안내 메시지
  - 네트워크 오류로 좌석 상태 업데이트 실패 시: 재시도 옵션 제공
  - 회차가 선택되지 않은 상태: 회차 선택 유도 메시지 표시
  - 좌석 데이터 로딩 실패 시: 오류 메시지 및 이전 단계로 돌아가기 옵션

---

## 🎯 **유저플로우 #5: 예약 페이지 - 예약 완료 처리 (고객 정보 입력 포함)**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- '좌석 선택 완료' 버튼 클릭
- 고객 정보 입력 폼에서 이름 입력
- 휴대폰 번호 입력
- 이메일 주소 입력 (선택사항)
- '예약 확정' 버튼 클릭

### **2. 처리 (시스템 내부 로직)**
1. **좌석 선택 완료 버튼 클릭 시**
   - 선택된 좌석 정보 유효성 재검증 (서버에서 실시간 상태 확인)
   - 좌석이 여전히 예약 가능한지 확인
   - 고객 정보 입력 폼 모달/섹션 활성화
   - 선택된 좌석에 대한 임시 예약 처리 (5분간 홀드)

2. **고객 정보 입력 및 검증**
   - 이름 필드: 필수 입력, 2-50자 제한, 특수문자 제한
   - 휴대폰 번호: 필수 입력, 한국 휴대폰 번호 형식 검증 (010-XXXX-XXXX)
   - 이메일: 선택 입력, 이메일 형식 검증
   - 실시간 입력 검증 및 오류 메시지 표시

3. **예약 확정 처리**
   - 최종 좌석 상태 재확인 (다른 사용자 예약 여부)
   - Reservation 테이블에 새 예약 레코드 생성
   - 선택된 좌석들의 status를 'reserved'로 업데이트 (Seat 테이블)
   - 예약 번호 생성 (UUID 또는 순차 번호)
   - 트랜잭션 처리로 데이터 일관성 보장

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 고객 정보 입력 폼 표시
  - 입력 필드별 실시간 검증 피드백
  - 예약 확정 시 예약 완료 페이지로 리다이렉트
  - 예약 번호와 함께 성공 메시지 표시
- **엣지케이스 처리**:
  - 좌석 선택이 없는 상태에서 버튼 클릭: 좌석 선택 유도 메시지
  - 임시 홀드 중 좌석이 다른 사용자에게 예약된 경우: 충돌 안내 및 좌석 재선택 유도
  - 고객 정보 입력 오류 시: 필드별 구체적 오류 메시지 표시
  - 중복된 휴대폰 번호로 동일 공연 예약 시도: 중복 예약 방지 안내
  - 네트워크 오류로 예약 처리 실패: 재시도 옵션 및 입력 데이터 보존
  - 임시 홀드 시간 초과 (5분): 세션 만료 안내 및 처음부터 다시 시작 유도
  - 서버 오류로 예약 생성 실패: 오류 안내 및 고객센터 연락처 제공

---

## 🎯 **유저플로우 #6: 예약 완료 페이지 - 예약 확인**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- 예약 완료 페이지 자동 진입 (예약 처리 성공 후)
- 예약 정보 확인 및 스크린샷/저장
- '예약 조회하기' 버튼 클릭
- '메인으로 돌아가기' 버튼 클릭

### **2. 처리 (시스템 내부 로직)**
1. **페이지 초기 로드**
   - URL 파라미터 또는 세션에서 예약 ID 추출
   - Reservation 테이블에서 예약 정보 조회
   - 관련 데이터 조인 (Concert, Schedule, Seat 테이블)
   - 예약 상세 정보 구성 (콘서트명, 일시, 좌석번호, 총금액)
   - 예약 번호 및 예약자 정보 표시 준비

2. **액션 버튼 처리**
   - '예약 조회하기' 클릭 시: 예약 조회 페이지로 이동 (/reservations)
   - '메인으로 돌아가기' 클릭 시: 메인 페이지로 이동 (/)
   - 페이지 이동 시 세션 데이터 정리

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 예약 완료 축하 메시지 표시
  - 예약 번호 및 예약자 이름 표시
  - 콘서트 정보 (제목, 포스터) 표시
  - 관람 일시 (날짜, 시간) 표시
  - 선택한 좌석 번호 목록 표시
  - 최종 결제 금액 표시
  - 후속 액션 버튼들 제공
- **엣지케이스 처리**:
  - 예약 ID가 유효하지 않은 경우: 404 에러 페이지로 리다이렉트
  - 예약 정보 조회 실패 시: 오류 메시지 및 메인 페이지 이동 옵션
  - 예약이 취소된 상태인 경우: 취소된 예약임을 명시하고 상태 표시
  - 네트워크 오류로 데이터 로드 실패: 재시도 버튼 제공
  - 직접 URL 접근으로 예약 컨텍스트 없이 진입: 예약 조회 페이지로 안내
  - 예약 데이터 로딩 중: 로딩 인디케이터 표시
  - 브라우저 뒤로가기 시: 예약 중복 방지를 위해 메인 페이지로 리다이렉트

---

## 🎯 **유저플로우 #7: 예약 조회 페이지 - 예약 검색**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- 예약 조회 페이지 진입 (/reservations)
- 예약 번호 입력 필드에 값 입력
- 연락처 입력 필드에 휴대폰 번호 또는 이메일 입력
- '조회하기' 버튼 클릭
- 검색 결과에서 특정 예약 카드 클릭

### **2. 처리 (시스템 내부 로직)**
1. **페이지 초기 로드**
   - 검색 폼 초기화
   - 입력 필드 유효성 검증 규칙 설정
   - 이전 검색 결과 초기화

2. **예약 검색 처리**
   - 입력 데이터 유효성 검증 (예약 번호 형식, 연락처 형식)
   - 검색 조건 구성 (예약 번호 OR 연락처 기준)
   - Reservation 테이블에서 조건에 맞는 예약 검색
   - 관련 데이터 조인 (Concert, Schedule 테이블)
   - 검색 결과를 최신순으로 정렬
   - 예약 상태별 필터링 (취소된 예약도 포함하여 표시)

3. **예약 카드 클릭 처리**
   - 선택된 예약의 ID 추출
   - 예약 상세 페이지로 이동 (/reservations/[reservationId])

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 검색 폼 표시 (예약 번호, 연락처 입력 필드)
  - 검색 결과를 카드 형태로 목록 표시
  - 각 카드에 콘서트명, 관람일시, 예약상태, 좌석정보 요약 표시
  - 예약 카드 클릭 시 상세 페이지로 이동
- **엣지케이스 처리**:
  - 검색 조건이 입력되지 않은 경우: 입력 필드 필수 안내 메시지
  - 잘못된 형식의 예약 번호 입력: 형식 오류 안내 메시지
  - 잘못된 형식의 연락처 입력: 휴대폰 번호 또는 이메일 형식 안내
  - 검색 결과가 없는 경우: 검색 결과 없음 안내 및 입력 정보 재확인 유도
  - 네트워크 오류로 검색 실패: 재시도 버튼 및 오류 메시지
  - 검색 중 로딩 상태: 로딩 인디케이터 및 검색 버튼 비활성화
  - 다수의 검색 결과 (10개 이상): 페이지네이션 또는 더보기 기능 제공
  - 취소된 예약 포함 시: 예약 상태를 명확히 구분하여 표시

---

## 🎯 **유저플로우 #8: 예약 상세 페이지 - 예약 취소**

### **1. 입력 (사용자 UI 입력 및 상호작용)**
- 예약 상세 페이지 진입 (/reservations/[reservationId])
- 예약 상세 정보 확인
- '예약 취소하기' 버튼 클릭
- 취소 확인 다이얼로그에서 '확인' 또는 '취소' 선택
- '목록으로 돌아가기' 버튼 클릭

### **2. 처리 (시스템 내부 로직)**
1. **페이지 초기 로드**
   - URL에서 reservationId 추출 및 유효성 검증
   - Reservation 테이블에서 예약 정보 조회
   - 관련 데이터 조인 (Concert, Schedule, Seat 테이블)
   - 예약 상태 확인 (confirmed/cancelled)
   - 취소 가능 여부 판단 (공연 시간, 취소 정책 기준)

2. **취소 가능 여부 검증**
   - 현재 시간과 공연 시간 비교 (예: 공연 2시간 전까지 취소 가능)
   - 예약 상태가 'confirmed'인지 확인
   - 이미 취소된 예약인지 확인

3. **예약 취소 처리**
   - 취소 확인 다이얼로그 표시
   - 사용자 확인 시 트랜잭션 시작
   - Reservation 테이블의 status를 'cancelled'로 업데이트
   - cancelledAt 필드에 현재 시간 기록
   - 관련 좌석들의 status를 'available'로 복원 (Seat 테이블)
   - 트랜잭션 커밋 및 성공 메시지 표시

### **3. 출력 (사용자 피드백 및 사이드이펙트)**
- **성공 시**: 
  - 예약 번호 및 예약자 정보 표시
  - 콘서트 정보 (제목, 포스터) 표시
  - 관람 일시 및 좌석 정보 표시
  - 예약 상태 (확정/취소) 명확히 표시
  - 취소 가능한 경우 '예약 취소하기' 버튼 활성화
  - 취소 완료 시 성공 메시지 및 상태 업데이트
- **엣지케이스 처리**:
  - 유효하지 않은 reservationId: 404 에러 페이지로 리다이렉트
  - 예약 정보 조회 실패: 오류 메시지 및 목록 페이지 이동 옵션
  - 이미 취소된 예약: 취소 상태 표시 및 취소 버튼 비활성화
  - 취소 불가능한 시간 (공연 임박): 취소 불가 안내 및 고객센터 연락처 제공
  - 취소 처리 중 네트워크 오류: 재시도 옵션 및 처리 상태 안내
  - 동시 취소 요청으로 인한 충돌: 이미 처리됨 안내 및 페이지 새로고침
  - 취소 확인 다이얼로그에서 '취소' 선택: 다이얼로그 닫기 및 원래 상태 유지
  - 예약 데이터 로딩 중: 스켈레톤 UI 또는 로딩 인디케이터 표시

---

## 📋 **유저플로우 요약**

### **주요 플로우 연결도**
```
메인 페이지 (콘서트 목록)
    ↓ [예매하기 클릭]
예약 페이지 - 날짜 선택
    ↓ [날짜 선택]
예약 페이지 - 회차 선택
    ↓ [회차 선택]
예약 페이지 - 좌석 선택
    ↓ [좌석 선택 완료]
예약 페이지 - 고객 정보 입력 & 예약 확정
    ↓ [예약 확정]
예약 완료 페이지
    ↓ [예약 조회하기]
예약 조회 페이지
    ↓ [예약 선택]
예약 상세 페이지 (취소 가능)
```

### **핵심 설계 원칙**
1. **90초 목표**: 각 단계별 최적화된 UX로 빠른 예매 완료 지원
2. **실시간 동기화**: 좌석 상태의 실시간 업데이트로 충돌 방지
3. **엣지케이스 대응**: 모든 예외 상황에 대한 명확한 사용자 안내
4. **데이터 일관성**: 트랜잭션 처리로 예약 데이터의 무결성 보장
5. **사용자 친화적**: 직관적인 UI와 명확한 피드백 제공

### **기술적 고려사항**
- 세션/로컬스토리지를 활용한 사용자 선택 상태 유지
- 실시간 폴링을 통한 좌석 상태 동기화
- 트랜잭션 처리를 통한 데이터 일관성 보장
- 임시 홀드 시스템으로 예약 충돌 최소화
- 반응형 디자인으로 모바일/데스크톱 모두 지원
